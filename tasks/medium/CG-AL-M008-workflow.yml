id: CG-AL-M008
prompt_template: code-gen.md
fix_template: bugfix.md
max_attempts: 2
description: >-
  Create a workflow implementation codeunit called "Purchase Approval Workflow" with ID 70003.

  Implement a complete approval workflow system with the following procedures:
  - InitiateApprovalProcess(PurchaseHeader: Record "Purchase Header"): Boolean - start approval workflow for a purchase document
  - ProcessApprovalRequest(DocumentNo: Code[20]; Action: Text; Comment: Text): Boolean - handle approval actions (APPROVE/REJECT) with comments
  - NotifyApprovers(PurchaseHeader: Record "Purchase Header"): Boolean - send notifications to appropriate approvers, return true if notification sent
  - EscalateApproval(DocumentNo: Code[20]): Boolean - escalate to higher authority, return true if escalated
  - CompleteApprovalProcess(DocumentNo: Code[20]): Boolean - finalize workflow, return true if completed successfully
  - DetermineApprover(PurchaseHeader: Record "Purchase Header"): Code[50] - determine approver based on document amount and business rules
  - GetApprovalHistoryCount(DocumentNo: Code[20]): Integer - return count of approval history entries for audit trail
  - CheckTimeout(DocumentNo: Code[20]): Boolean - check if approval request has timed out, return true if timed out
  - SendEmailNotification(PurchaseHeader: Record "Purchase Header"; Subject: Text) - send email notification with specified subject

  Include complex business logic:
  - Dynamic approver determination based on amount thresholds
  - Approval history tracking and audit trail
  - Timeout handling for pending approvals
  - Email notifications and reminders

  Use event subscribers for Purchase Header events, proper error handling,
  and comprehensive logging. Include approval status management and state transitions.
expected:
  compile: true
  testApp: tests/al/medium/CG-AL-M008.Test.al
  testCodeunitId: 80018
metrics:
  - compile_pass
  - tests_pass
  - pass_attempt
