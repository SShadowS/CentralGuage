id: CG-AL-M005
prompt_template: code-gen.md
fix_template: bugfix.md
max_attempts: 2
description: >-
  Create an integration codeunit called "External Payment Service" with ID 70002 that handles external API communication.
  The codeunit should implement the following procedures:

  - SendPaymentRequest(OrderId: Text; Amount: Decimal; Currency: Text; var ResponseJson: JsonObject): Boolean
    Send payment to external service. Parameters: OrderId (order identifier), Amount (payment amount),
    Currency (currency code), ResponseJson (VAR parameter to receive response). Returns true on success.

  - ValidatePaymentResponse(Response: JsonObject): Boolean
    Validate API response structure. Check for required fields (status, transactionId, amount).
    Returns true if response contains all required fields and status is 'approved', false otherwise.

  - GetPaymentStatus(TransactionId: Text): Text
    Check payment status for a transaction. Returns status as Text.

  - HandlePaymentWebhook(WebhookData: JsonObject): Boolean
    Process incoming webhook events. Webhook payloads contain an 'event' field
    (e.g., 'payment.completed', 'payment.failed', 'payment.refunded') along with
    transaction details. Returns true if webhook contains a valid event and is
    successfully handled, false if the event field is missing or the payload is empty.

  - LogPaymentTransaction(TransactionId: Text[50]; Amount: Decimal; Status: Text[20])
    Log payment transaction details for audit purposes.

  Include proper HTTP client usage with error handling, retry logic for failed requests,
  authentication headers, JSON serialization/deserialization, and timeout handling.
  Use HttpClient, JsonToken, JsonObject patterns and include comprehensive error messages.
metadata:
  target: OnPrem
expected:
  compile: true
  testApp: tests/al/medium/CG-AL-M005.Test.al
  testCodeunitId: 80015
metrics:
  - compile_pass
  - tests_pass
  - pass_attempt
