id: CG-AL-H023
prompt_template: code-gen.md
fix_template: bugfix.md
max_attempts: 2
description: >-
  Create a codeunit named "CG Record Introspector" with ID 70226 demonstrating advanced
  RecordRef and FieldRef techniques for dynamic record manipulation and introspection.

  1. Procedure "SerializeToJson" that takes Variant parameter SourceRecord and returns JsonObject.
     Convert any record to JSON dynamically:
     - Use RecordRef.GetTable() to get the record from variant
     - Iterate all fields using FieldIndex(1..FieldCount)
     - For each field, add to JsonObject with field name as key
     - Handle different field types: Text, Code, Integer, Decimal, Boolean, Date, DateTime, Option, Enum
     - Skip BLOB and Media fields (check FieldRef.Class = FieldClass::FlowField or type)
     - Include a "_metadata" object with TableName, TableId, and RecordId as string

  2. Procedure "DeserializeFromJson" that takes JsonObject parameter JsonData and
     var RecordRef parameter DestRecRef. Returns Boolean.
     Populate a RecordRef from JSON:
     - Read "_metadata" to validate TableId matches DestRecRef.Number
     - For each key in JsonObject (except _metadata), find matching field by name
     - Set field values handling type conversions (Text to Code, Integer to Decimal, etc.)
     - Return true if at least one field was set, false if table mismatch or no fields set

  3. Procedure "CompareRecords" that takes two Variant parameters Record1 and Record2,
     returns Dictionary of [Text, Text] containing differences.
     Compare two records of the same table:
     - Verify both are records of same table (return empty if not)
     - For each field, compare values using Format()
     - If different, add to dictionary: key = field name, value = "[old] -> [new]"
     - Skip FlowFields and BLOB fields

  4. Procedure "CloneRecord" that takes Variant parameter SourceRecord and
     var RecordRef parameter DestRecRef. Returns Boolean.
     Deep clone a record:
     - Copy all normal fields (not FlowFields, not BLOB)
     - Handle primary key: if DestRecRef already has PK set, keep it; otherwise copy from source
     - Return true if successful

  5. Procedure "GetTableSchema" that takes Integer parameter TableId,
     returns JsonArray of field info.
     Return complete schema for a table:
     - Each element is JsonObject with: FieldNo, FieldName, FieldType (as text), Length,
       FieldClass (Normal/FlowField/FlowFilter), RelatedTable (0 if none), IsPartOfPrimaryKey
     - Use KeyIndex(1) to determine which fields are in primary key

  6. Procedure "BuildDynamicFilter" that takes RecordRef parameter RecRef,
     Dictionary of [Text, Text] parameter FilterCriteria. Returns Boolean.
     Apply filters dynamically:
     - Dictionary keys are field names, values are filter expressions (e.g., "100..200", "A*", "<>''")
     - For each entry, find field by name, apply SetFilter on the FieldRef
     - Return true if all filters applied successfully, false if any field not found

  7. Procedure "GetRecordByPrimaryKey" that takes Integer parameter TableId,
     List of [Variant] parameter KeyValues, var RecordRef parameter ResultRecRef. Returns Boolean.
     Look up record by dynamic primary key:
     - Open table, get primary key field count
     - Apply filters for each key field using the corresponding KeyValues entry
     - Call FindFirst, return true if found
     - Handle composite keys (multiple fields)

  8. Procedure "TransformRecord" that takes var RecordRef parameter RecRef,
     Codeunit parameter Transformer implementing interface "IFieldTransformer". Returns Integer.
     Apply transformations to each field:
     - Iterate all fields
     - For each field, call Transformer.Transform(FieldRef) which returns new Variant value
     - If returned value differs from current, update the field
     - Return count of fields transformed

  9. Procedure "FindRelatedRecords" that takes RecordRef parameter SourceRecRef,
     Integer parameter RelatedTableId, returns List of [RecordId].
     Find all records in RelatedTable that reference the source record:
     - Open RelatedTable
     - Find fields with Relation pointing to source table
     - For each such field, filter by source record's primary key value
     - Return RecordIds of all matching records

  10. Procedure "ValidateRecordCompleteness" that takes RecordRef parameter RecRef,
      List of [Integer] parameter RequiredFieldNos. Returns List of [Text].
      Check which required fields are empty:
      - For each field number in list, check if field has a value
      - Text/Code: check if not empty string
      - Integer/Decimal: check if not 0 (or accept 0 if explicitly allowed)
      - Boolean: always valid
      - Date: check if not 0D
      - Return list of field names that are empty/missing

  Include Access = Public on the codeunit.

  Also create interface "IFieldTransformer" with procedure:
  Transform(var FieldRef: FieldRef): Variant
  (Return the new value to set, or the same value to keep unchanged)
expected:
  compile: true
  testApp: tests/al/hard/CG-AL-H023.Test.al
metrics:
  - compile_pass
  - tests_pass
  - pass_attempt
