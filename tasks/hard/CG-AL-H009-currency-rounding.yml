id: CG-AL-H009
prompt_template: code-gen.md
fix_template: bugfix.md
max_attempts: 2
description: >-
  Create a codeunit that implements proper BC currency rounding patterns.

  Create codeunit "CG Price Calculator" (ID 70213) with Access = Public.

  The codeunit should work with the standard Currency table's rounding precision fields.

  Implement these procedures:

  1. CalculateLineAmount(UnitPrice: Decimal; Quantity: Decimal; DiscountPercent: Decimal; CurrencyCode: Code[10]): Decimal
     - Calculate: LineAmount = UnitPrice * Quantity
     - Apply discount: LineAmount = LineAmount * (1 - DiscountPercent / 100)
     - Round using Currency."Amount Rounding Precision"
     - If CurrencyCode is empty, use 0.01 as default precision
     - Use the Currency.InitRoundingPrecision() pattern if Currency record not found

  2. CalculateUnitPriceFromAmount(TotalAmount: Decimal; Quantity: Decimal; CurrencyCode: Code[10]): Decimal
     - Calculate: UnitPrice = TotalAmount / Quantity
     - Round using Currency."Unit-Amount Rounding Precision"
     - If Quantity is 0, return 0 (not an error)
     - If CurrencyCode is empty, use 0.00001 as default precision

  3. RoundAmount(Amount: Decimal; CurrencyCode: Code[10]; Direction: Text[1]): Decimal
     - Direction: '<' for down, '=' for nearest, '>' for up
     - Uses Currency."Amount Rounding Precision"
     - Uses Round(Amount, Precision, Direction) function

  4. GetVATAmount(BaseAmount: Decimal; VATPercent: Decimal; CurrencyCode: Code[10]): Decimal
     - Calculate: VAT = BaseAmount * VATPercent / 100
     - Round using Currency."Amount Rounding Precision"
     - Negative BaseAmount should return negative VAT

  Critical: Must use Currency.Get() with proper handling when currency not found.
  Use Currency.InitRoundingPrecision() to set defaults.
expected:
  compile: true
  testApp: tests/al/hard/CG-AL-H009.Test.al
metrics:
  - compile_pass
  - tests_pass
  - pass_attempt
